---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Astro6IssueCard from '../../components/Astro6IssueCard.astro';
import issuesDataRaw from '../../data/astro6-issues.json';

interface Issue {
  id: string;
  title: string;
  category: string;
  severity: 'critical' | 'high' | 'medium' | 'low';
  status: 'solved' | 'potential' | 'in-progress';
  symptom: string;
  description: string;
  solution: string;
  codeExample: { before: string; after: string };
  docLink: string;
  notes: string;
}

const issuesData = (issuesDataRaw as any).issues as Issue[];

// Extract unique categories and statuses
const categories = [...new Set(issuesData.map((i) => i.category))].sort();
const statuses = ['solved', 'in-progress', 'potential'];

// Organize issues by category
const issuesByCategory = categories.reduce(
  (acc, cat) => {
    acc[cat] = issuesData.filter((i) => i.category === cat);
    return acc;
  },
  {} as Record<string, Issue[]>
);

const title = "Astro 6.0 Deployment Troubleshooting Guide";
const description = "Technical documentation of migration challenges and solutions for Astro 6.0 on Cloudflare.";
---

<BaseLayout title={title} description={description}>
  <div class="max-w-6xl mx-auto px-6 py-24">
    <!-- Navigation -->
    <nav class="mb-12">
      <a href="/" class="inline-flex items-center text-sm font-bold text-stone-500 hover:text-orange-500 transition-colors group">
        <svg class="mr-2 w-4 h-4 transition-transform group-hover:-translate-x-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
        </svg>
        Back to Home
      </a>
    </nav>

    <!-- Header -->
    <div class="text-center mb-16">
      <div class="flex items-center justify-center gap-4 mb-6">
        <div class="h-[1px] w-12 bg-orange-600"></div>
        <span class="text-orange-500 font-bold uppercase tracking-[0.3em] text-sm">Technical Log</span>
        <div class="h-[1px] w-12 bg-orange-600"></div>
      </div>
      <h1 class="text-4xl md:text-6xl font-display font-bold text-white mb-6 uppercase tracking-tight">
        Astro 6.0 <span class="text-stone-500">Troubleshooting</span>
      </h1>
      <p class="text-xl text-stone-400 max-w-2xl mx-auto leading-relaxed">
        Real-world solutions for challenges encountered during the migration to Astro 6.0 and Cloudflare's 2026 infrastructure.
      </p>
    </div>

    <!-- Stats -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-16">
      <div class="bg-stone-900/50 p-6 rounded-sm border border-stone-800 text-center backdrop-blur-sm">
        <div class="text-3xl font-display font-bold text-orange-600 mb-1">{issuesData.length}</div>
        <div class="text-[10px] font-bold text-stone-500 uppercase tracking-widest">Total Issues</div>
      </div>
      <div class="bg-stone-900/50 p-6 rounded-sm border border-stone-800 text-center backdrop-blur-sm">
        <div class="text-3xl font-display font-bold text-emerald-500 mb-1">{issuesData.filter((i) => i.status === 'solved').length}</div>
        <div class="text-[10px] font-bold text-stone-500 uppercase tracking-widest">Solved</div>
      </div>
      <div class="bg-stone-900/50 p-6 rounded-sm border border-stone-800 text-center backdrop-blur-sm">
        <div class="text-3xl font-display font-bold text-sky-500 mb-1">{categories.length}</div>
        <div class="text-[10px] font-bold text-stone-500 uppercase tracking-widest">Categories</div>
      </div>
      <div class="bg-stone-900/50 p-6 rounded-sm border border-stone-800 text-center backdrop-blur-sm">
        <div class="text-3xl font-display font-bold text-red-500 mb-1">{issuesData.filter((i) => i.severity === 'critical').length}</div>
        <div class="text-[10px] font-bold text-stone-500 uppercase tracking-widest">Critical</div>
      </div>
    </div>

    <!-- Filters -->
    <div class="bg-stone-900 border border-stone-800 p-8 mb-16 relative overflow-hidden shadow-2xl">
      <div class="absolute top-0 left-0 w-1 h-full bg-orange-600"></div>
      
      <div class="mb-10">
        <label for="searchBox" class="block text-xs font-bold text-stone-500 mb-3 uppercase tracking-[0.2em]">Search Knowledge Base</label>
        <input
          type="text"
          id="searchBox"
          class="w-full bg-stone-950 border border-stone-800 focus:border-orange-600 p-4 font-bold text-white focus:outline-none transition-all text-sm uppercase placeholder:text-stone-800"
          placeholder="Keyword, error message, or component name..."
        />
      </div>

      <div class="grid md:grid-cols-3 gap-10">
        <div>
          <h3 class="text-[10px] font-bold text-stone-600 uppercase tracking-widest mb-4">Status</h3>
          <div class="flex flex-wrap gap-2">
            <button class="filter-button px-3 py-1.5 border border-stone-800 text-[10px] font-bold uppercase tracking-widest hover:border-orange-600 active-filter" data-filter="status" data-value="all">All</button>
            {
              statuses.map(status => (
                <button class="filter-button px-3 py-1.5 border border-stone-800 text-[10px] font-bold uppercase tracking-widest hover:border-orange-600" data-filter="status" data-value={status}>
                  {status}
                </button>
              ))
            }
          </div>
        </div>

        <div>
          <h3 class="text-[10px] font-bold text-stone-600 uppercase tracking-widest mb-4">Severity</h3>
          <div class="flex flex-wrap gap-2">
            <button class="filter-button px-3 py-1.5 border border-stone-800 text-[10px] font-bold uppercase tracking-widest hover:border-orange-600 active-filter" data-filter="severity" data-value="all">All</button>
            <button class="filter-button px-3 py-1.5 border border-stone-800 text-[10px] font-bold uppercase tracking-widest hover:border-orange-600" data-filter="severity" data-value="critical">Critical</button>
            <button class="filter-button px-3 py-1.5 border border-stone-800 text-[10px] font-bold uppercase tracking-widest hover:border-orange-600" data-filter="severity" data-value="high">High</button>
            <button class="filter-button px-3 py-1.5 border border-stone-800 text-[10px] font-bold uppercase tracking-widest hover:border-orange-600" data-filter="severity" data-value="medium">Medium</button>
          </div>
        </div>

        <div>
          <h3 class="text-[10px] font-bold text-stone-600 uppercase tracking-widest mb-4">Category</h3>
          <div class="flex flex-wrap gap-2">
            <button class="filter-button px-3 py-1.5 border border-stone-800 text-[10px] font-bold uppercase tracking-widest hover:border-orange-600 active-filter" data-filter="category" data-value="all">All</button>
            {
              categories.map(cat => (
                <button class="filter-button px-3 py-1.5 border border-stone-800 text-[10px] font-bold uppercase tracking-widest hover:border-orange-600" data-filter="category" data-value={cat}>
                  {cat}
                </button>
              ))
            }
          </div>
        </div>
      </div>
    </div>

    <!-- Issues -->
    <div class="space-y-24" id="issuesContainer">
      {
        categories.map(category => (
          <div class="category-section" data-category={category}>
            <div class="flex items-center gap-4 mb-10">
              <h2 class="text-xl font-display font-bold text-white uppercase tracking-wider">{category}</h2>
              <div class="h-px flex-1 bg-stone-800"></div>
            </div>
            <div class="grid gap-12">
              {issuesByCategory[category].map((issue) => (
                <Astro6IssueCard {...issue} />
              ))}
            </div>
          </div>
        ))
      }
    </div>

    <div class="hidden text-center py-32 bg-stone-900 border border-stone-800" id="noResults">
      <p class="text-xl font-display font-bold text-stone-500 uppercase tracking-widest mb-6">No matching logs found</p>
      <button id="clearFilters" class="text-orange-600 font-bold uppercase text-xs tracking-[0.2em] hover:text-orange-500">Reset System Filters</button>
    </div>
  </div>

  <style is:global>
    .active-filter {
      background-color: #c2410c !important;
      border-color: #c2410c !important;
      color: white !important;
    }
    
    /* Override standard card colors for dark theme if needed, 
       but Astro6IssueCard already uses white/slate which provides good contrast on dark */
  </style>

  <script>
    interface FilterState {
      status: string;
      severity: string;
      category: string;
      search: string;
    }

    const filterState: FilterState = {
      status: 'all',
      severity: 'all',
      category: 'all',
      search: '',
    };

    const issuesContainer = document.getElementById('issuesContainer');
    const noResults = document.getElementById('noResults');
    const searchBox = document.getElementById('searchBox');
    const clearFiltersBtn = document.getElementById('clearFilters');

    // Extract issues data from DOM
    const allIssues = Array.from(document.querySelectorAll('[data-issue-id]')).map(
      element => {
        const el = element as HTMLElement;
        return {
          id: el.dataset.issueId,
          title: el.querySelector('h3')?.textContent || '',
          category: el.dataset.category || '',
          severity: el.dataset.severity || '',
          status: el.dataset.status || '',
          element: el,
        };
      }
    );

    function filterIssues() {
      let visibleCount = 0;

      allIssues.forEach(issue => {
        const matchesStatus = filterState.status === 'all' || issue.status === filterState.status;
        const matchesSeverity = filterState.severity === 'all' || issue.severity === filterState.severity;
        const matchesCategory = filterState.category === 'all' || issue.category === filterState.category;

        const searchLower = filterState.search.toLowerCase();
        const matchesSearch =
          !filterState.search ||
          issue.title.toLowerCase().includes(searchLower) ||
          issue.element.textContent?.toLowerCase().includes(searchLower);

        const isVisible = matchesStatus && matchesSeverity && matchesCategory && (matchesSearch || false);
        issue.element.style.display = isVisible ? 'block' : 'none';

        if (isVisible) visibleCount++;
      });

      // Show/hide category sections
      document.querySelectorAll('.category-section').forEach(section => {
        const visibleIssues = section.querySelectorAll('[data-issue-id]:not([style*="display: none"])').length;
        (section as HTMLElement).style.display = visibleIssues > 0 ? 'block' : 'none';
      });

      // Show no results message
      if (visibleCount === 0) {
        noResults!.classList.remove('hidden');
        issuesContainer!.classList.add('hidden');
      } else {
        noResults!.classList.add('hidden');
        issuesContainer!.classList.remove('hidden');
      }
    }

    // Event listeners for filter buttons
    document.querySelectorAll('.filter-button').forEach(button => {
      button.addEventListener('click', function(this: HTMLButtonElement) {
        const filterType = this.dataset.filter || '';
        const filterValue = this.dataset.value || '';

        // Update active state
        document
          .querySelectorAll(`.filter-button[data-filter="${filterType}"]`)
          .forEach(btn => btn.classList.remove('active-filter'));
        this.classList.add('active-filter');

        // Update filter state
        filterState[filterType as keyof FilterState] = filterValue;
        filterIssues();
      });
    });

    // Search box
    searchBox!.addEventListener('input', function(this: HTMLInputElement) {
      filterState.search = this.value;
      filterIssues();
    });

    // Clear filters
    clearFiltersBtn?.addEventListener('click', () => {
      filterState.status = 'all';
      filterState.severity = 'all';
      filterState.category = 'all';
      filterState.search = '';
      if (searchBox) (searchBox as HTMLInputElement).value = '';
      
      document.querySelectorAll('.filter-button').forEach(btn => btn.classList.remove('active-filter'));
      document.querySelectorAll('.filter-button[data-value="all"]').forEach(btn => btn.classList.add('active-filter'));
      
      filterIssues();
    });

    // Initial filter run
    filterIssues();
  </script>
</BaseLayout>
