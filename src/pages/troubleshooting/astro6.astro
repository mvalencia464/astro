---
import Astro6IssueCard from '../../components/Astro6IssueCard.astro';
import issuesDataRaw from '../../data/astro6-issues.json';

interface Issue {
  id: string;
  title: string;
  category: string;
  severity: 'critical' | 'high' | 'medium' | 'low';
  status: 'solved' | 'potential' | 'in-progress';
  symptom: string;
  description: string;
  solution: string;
  codeExample: { before: string; after: string };
  docLink: string;
  notes: string;
}

const issuesData = (issuesDataRaw as any).issues as Issue[];

// Extract unique categories and statuses
const categories = [...new Set(issuesData.map((i) => i.category))].sort();
const statuses = ['solved', 'in-progress', 'potential'];

// Organize issues by category
const issuesByCategory = categories.reduce(
  (acc, cat) => {
    acc[cat] = issuesData.filter((i) => i.category === cat);
    return acc;
  },
  {} as Record<string, Issue[]>
);
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Astro 6.0 Deployment Troubleshooting Guide</title>
  </head>

  <body class="bg-slate-50 text-slate-900 font-sans leading-relaxed">
    <div class="max-w-6xl mx-auto px-4 py-12">
      <!-- Navigation -->
      <nav class="mb-12">
        <a href="/" class="inline-flex items-center text-sm font-bold text-slate-500 hover:text-blue-600 transition-colors group">
          <svg class="mr-2 w-4 h-4 transition-transform group-hover:-translate-x-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
          </svg>
          Back to Home
        </a>
      </nav>

      <!-- Header -->
      <div class="text-center mb-16">
        <h1 class="text-4xl md:text-5xl font-extrabold text-slate-900 mb-4 tracking-tight">
          Astro 6.0 Deployment Troubleshooting
        </h1>
        <p class="text-xl text-slate-600 max-w-2xl mx-auto">
          A comprehensive guide to issues encountered during migration to Astro 6.0 and how we solved them.
        </p>
      </div>

      <!-- Stats -->
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-12">
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 text-center">
          <div class="text-3xl font-bold text-blue-600 mb-1">{issuesData.length}</div>
          <div class="text-xs font-semibold text-slate-500 uppercase tracking-wider text-wrap">Total Issues</div>
        </div>
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 text-center">
          <div class="text-3xl font-bold text-green-600 mb-1">{issuesData.filter((i) => i.status === 'solved').length}</div>
          <div class="text-xs font-semibold text-slate-500 uppercase tracking-wider">Solved</div>
        </div>
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 text-center">
          <div class="text-3xl font-bold text-indigo-600 mb-1">{categories.length}</div>
          <div class="text-xs font-semibold text-slate-500 uppercase tracking-wider">Categories</div>
        </div>
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 text-center">
          <div class="text-3xl font-bold text-red-600 mb-1">{issuesData.filter((i) => i.severity === 'critical').length}</div>
          <div class="text-xs font-semibold text-slate-500 uppercase tracking-wider">Critical</div>
        </div>
      </div>

      <!-- Filters -->
      <div class="bg-white rounded-2xl shadow-md border border-slate-200 p-8 mb-12">
        <div class="mb-8">
          <label for="searchBox" class="block text-sm font-bold text-slate-700 mb-2 uppercase tracking-wide">Search Troubleshooting Guide</label>
          <input
            type="text"
            id="searchBox"
            class="w-full px-5 py-3 bg-slate-50 border-2 border-slate-200 rounded-xl text-lg focus:outline-none focus:border-blue-500 focus:bg-white transition-all"
            placeholder="Search by title, symptom, or solution..."
          />
        </div>

        <div class="grid md:grid-cols-3 gap-8">
          <div>
            <h3 class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-4">Filter by Status</h3>
            <div class="flex flex-wrap gap-2">
              <button class="filter-button px-4 py-2 rounded-lg border-2 border-slate-200 bg-white text-sm font-semibold hover:border-blue-300 hover:bg-blue-50 transition-all active-filter" data-filter="status" data-value="all">All</button>
              {
                statuses.map(status => (
                  <button class="filter-button px-4 py-2 rounded-lg border-2 border-slate-200 bg-white text-sm font-semibold hover:border-blue-300 hover:bg-blue-50 transition-all" data-filter="status" data-value={status}>
                    {status.charAt(0).toUpperCase() + status.slice(1)}
                  </button>
                ))
              }
            </div>
          </div>

          <div>
            <h3 class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-4">Filter by Severity</h3>
            <div class="flex flex-wrap gap-2">
              <button class="filter-button px-4 py-2 rounded-lg border-2 border-slate-200 bg-white text-sm font-semibold hover:border-blue-300 hover:bg-blue-50 transition-all active-filter" data-filter="severity" data-value="all">All</button>
              <button class="filter-button px-4 py-2 rounded-lg border-2 border-slate-200 bg-white text-sm font-semibold hover:border-blue-300 hover:bg-blue-50 transition-all" data-filter="severity" data-value="critical">Critical</button>
              <button class="filter-button px-4 py-2 rounded-lg border-2 border-slate-200 bg-white text-sm font-semibold hover:border-blue-300 hover:bg-blue-50 transition-all" data-filter="severity" data-value="high">High</button>
              <button class="filter-button px-4 py-2 rounded-lg border-2 border-slate-200 bg-white text-sm font-semibold hover:border-blue-300 hover:bg-blue-50 transition-all" data-filter="severity" data-value="medium">Medium</button>
            </div>
          </div>

          <div>
            <h3 class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-4">Filter by Category</h3>
            <div class="flex flex-wrap gap-2">
              <button class="filter-button px-4 py-2 rounded-lg border-2 border-slate-200 bg-white text-sm font-semibold hover:border-blue-300 hover:bg-blue-50 transition-all active-filter" data-filter="category" data-value="all">All</button>
              {
                categories.map(cat => (
                  <button class="filter-button px-4 py-2 rounded-lg border-2 border-slate-200 bg-white text-sm font-semibold hover:border-blue-300 hover:bg-blue-50 transition-all" data-filter="category" data-value={cat}>
                    {cat}
                  </button>
                ))
              }
            </div>
          </div>
        </div>
      </div>

      <!-- Issues -->
      <div class="space-y-16" id="issuesContainer">
        {
          categories.map(category => (
            <div class="category-section" data-category={category}>
              <h2 class="text-2xl font-bold text-slate-900 mb-8 pb-4 border-b-4 border-blue-500 inline-block">{category}</h2>
              <div class="grid gap-8">
                {issuesByCategory[category].map((issue) => (
                  <Astro6IssueCard {...issue} />
                ))}
              </div>
            </div>
          ))
        }
      </div>

      <div class="hidden text-center py-20 bg-white rounded-2xl shadow-sm border border-slate-200" id="noResults">
        <div class="text-slate-400 mb-4">
          <svg class="w-16 h-16 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 9.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
        </div>
        <p class="text-xl font-medium text-slate-600">No issues match your search or filters.</p>
        <button id="clearFilters" class="mt-4 text-blue-600 font-semibold hover:underline">Clear all filters</button>
      </div>
    </div>

    <style>
      .active-filter {
        background-color: #3b82f6 !important;
        border-color: #3b82f6 !important;
        color: white !important;
      }
    </style>

    <script>
      interface FilterState {
        status: string;
        severity: string;
        category: string;
        search: string;
      }

      const filterState: FilterState = {
        status: 'all',
        severity: 'all',
        category: 'all',
        search: '',
      };

      const issuesContainer = document.getElementById('issuesContainer');
      const noResults = document.getElementById('noResults');
      const searchBox = document.getElementById('searchBox');
      const clearFiltersBtn = document.getElementById('clearFilters');

      // Extract issues data from DOM
      const allIssues = Array.from(document.querySelectorAll('[data-issue-id]')).map(
        element => {
          const el = element as HTMLElement;
          return {
            id: el.dataset.issueId,
            title: el.querySelector('h3')?.textContent || '',
            category: el.dataset.category || '',
            severity: el.dataset.severity || '',
            status: el.dataset.status || '',
            element: el,
          };
        }
      );

      function filterIssues() {
        let visibleCount = 0;

        allIssues.forEach(issue => {
          const matchesStatus = filterState.status === 'all' || issue.status === filterState.status;
          const matchesSeverity = filterState.severity === 'all' || issue.severity === filterState.severity;
          const matchesCategory = filterState.category === 'all' || issue.category === filterState.category;

          const searchLower = filterState.search.toLowerCase();
          const matchesSearch =
            !filterState.search ||
            issue.title.toLowerCase().includes(searchLower) ||
            issue.element.textContent?.toLowerCase().includes(searchLower);

          const isVisible = matchesStatus && matchesSeverity && matchesCategory && (matchesSearch || false);
          issue.element.style.display = isVisible ? 'block' : 'none';

          if (isVisible) visibleCount++;
        });

        // Show/hide category sections
        document.querySelectorAll('.category-section').forEach(section => {
          const visibleIssues = section.querySelectorAll('[data-issue-id]:not([style*="display: none"])').length;
          (section as HTMLElement).style.display = visibleIssues > 0 ? 'block' : 'none';
        });

        // Show no results message
        if (visibleCount === 0) {
          noResults!.classList.remove('hidden');
          issuesContainer!.classList.add('hidden');
        } else {
          noResults!.classList.add('hidden');
          issuesContainer!.classList.remove('hidden');
        }
      }

      // Event listeners for filter buttons
      document.querySelectorAll('.filter-button').forEach(button => {
        button.addEventListener('click', function(this: HTMLButtonElement) {
          const filterType = this.dataset.filter || '';
          const filterValue = this.dataset.value || '';

          // Update active state
          document
            .querySelectorAll(`.filter-button[data-filter="${filterType}"]`)
            .forEach(btn => btn.classList.remove('active-filter'));
          this.classList.add('active-filter');

          // Update filter state
          filterState[filterType as keyof FilterState] = filterValue;
          filterIssues();
        });
      });

      // Search box
      searchBox!.addEventListener('input', function(this: HTMLInputElement) {
        filterState.search = this.value;
        filterIssues();
      });

      // Clear filters
      clearFiltersBtn?.addEventListener('click', () => {
        filterState.status = 'all';
        filterState.severity = 'all';
        filterState.category = 'all';
        filterState.search = '';
        (searchBox as HTMLInputElement).value = '';
        
        document.querySelectorAll('.filter-button').forEach(btn => btn.classList.remove('active-filter'));
        document.querySelectorAll('.filter-button[data-value="all"]').forEach(btn => btn.classList.add('active-filter'));
        
        filterIssues();
      });

      // Initial filter run
      filterIssues();
    </script>
  </body>
</html>
